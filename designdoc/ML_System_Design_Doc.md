![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/443c555b-de43-4042-8727-c27cbc430085)
# ML System Design Doc - [RU]
## Дизайн ML системы - <Прогнозирование стоимости акций Google> <MVP of ML System «Прогнозирования стоимости акций крупнейших интернет-компаний»> <№001>
### Шаблон ML System Design Doc от телеграм-канала Reliable ML

## Термины и пояснения:
> - Итерация - это все работы, которые совершаются до старта очередного пилота
> - БТ - бизнес-требования
> - EDA - Exploratory Data Analysis - исследовательский анализ данных
> - Product Owner, Data Scientist - роли, которые заполняют соответствующие разделы
> - Пилот - Ограниченное развёртывание - ИТ-услуги, релиза или процесса в среде промышленной эксплуатации. Пилот используется для сокращения рисков, проведения пользовательской приёмки и получения обратной связи от пользователей
> - ML модель - моделью машинного обучения называется программный код, обученный распознаванию определенных типов закономерностей и выработке алгоритмов решения различных задач на основе анализа набора данных
> - Baseline (в ML) - это результат работы очень простой ML модели/решения используемый для сравнения с результатами более сложных моделей/решений с целью выбора наилучшего результата

## 1. Цели и предпосылки

### 1.1. Зачем идем в разработку продукта?
- #### Бизнес-цель  
Создание команды, обучение и создание прототипа информационного сервиса по предсказанию стоимости акций для инвесторов.
- #### Почему станет лучше, чем сейчас, от использования ML  
На первом этапе проект носит обучающий характер и призван наладить работу команды и познакомить членов с предметной областью, подходами к предиктивной аналитике, ML решениями в области торговли финансовыми инструментами и разработке решения доступного и понятного для рядового инвестора. 
- #### Что будем считать успехом итерации с точки зрения бизнеса  
Успехом будем считать полностью законченный продукт в виде ML модели предсказания цен на акции ведущих интернет-компаний представленной информационном сервисом для третьих лица.

### 1.2. Бизнес-требования и ограничения
- #### Краткое описание БТ и ссылки на детальные документы с бизнес-требованиями Product  
Сервис по прогнозированию стоимости акций должен носить информационный характер и ориентирован на аудиторию вовлеченную в долгосрочное инвестирование. Бизнес требования формировались на основе сравнительного анализа с сервисами конкурентов [ссылка на документ со сравнительным анализом конкурентов].
- #### Бизнес-ограничения  
Интересуют только акции ведущих мировых компаний IT сектора. Срок окончания итерации 15-20 декабря 2023 года. В рамках настоящей итерации, кроме покупки хостинга для размещения базы данных, финансовых расходов не планируются.
- #### Что мы ожидаем от конкретной итерации  
Product Owner ожидает, что на первой итерации проекта будет реализован прототип системы представленный сервисом который должен включать сбор и хранение необходимых для прогнозирования данных, их обработку исходя из меняемых параметров и визуализацию полученных результатов.   
- #### Описание бизнес-процесса пилота, насколько это возможно - как именно мы будем использовать модель в существующем бизнес-процессе?  
ML модель прогнозирования стоимости акций будет встроена в онлайн сервис на котором будет представлена возможность ввода ряда параметров (период прогнозирования, временной интервал анализа данных, выбор вида ценной бумаги) и визуализаций отражающих значение прогнозируемых данных. 
- #### Что считаем успешным пилотом? Критерии успеха и возможные пути развития проекта  
  Product Owner определил следующие критерии успеха для пилотного проекта:
  
  - Реализация в виде онлайн сервиса с собственной базой данных котировок
  - Создание валидной ML модели прогнозирования стоимости акций IT компаний
  Направления улучшения проекта:
  - Универсализация сервиса путем увеличение количества прогнозируемых акций
  - Улучшение качества и количества исходных данных
  - Возможность выбора фичей и моделей
  - Интеграция с торговыми (инвестиционными) платформами
  - Прочее расширение функционала сервиса

### 1.3. Что входит в скоуп проекта/итерации, что не входит
- #### На закрытие каких БТ подписываемся в данной итерации  
  - В первой итерации разработчик планирует создать модель для прогнозирования акций на месяц вперёд с суточной разбивкой.  
  - Модель должна будет включена в сервис с собственной базой данных и онлайн визуализацией результатов.
- #### Что не будет закрыто  
  - Возможность выбора периода прогнозирования  
  - Не учитываются данные финансовой статистики компаний
  - Не учитывается влияние новостных факторов
  - Не учитывается влияние макроэкономических и секторальных (отраслевых) факторов
  - Прогнозные значения полученные в сервисе не является инвестиционной рекомендацией
- #### Описание результата с точки зрения качества кода и воспроизводимости решения  
Планируется, что код, будет сопровождаться документацией и комментариями для обеспечения понимания другими разработчиками. Модель должна обеспечивать повторное обучения модели на вновь поступающих данных.
- #### Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации) Data Scientist
  Для дальнейшей продуктивизации проекта остается следующий технический долг:
  
  - Увеличение количества прогнозируемых акций и финансовых инструментов.
  - Увеличение количества используемых данных и настройка их использования из сервиса, в том числе выбор временных интервалов.
  - Выбор моделей и возможности пользовательской настроек параметров моделей. 
  - Интеграция с торговыми (инвестиционными) платформами и совершение сделок напрямую из сервиса.
  - Возможность выбора периода прогнозирования.
  - Создания личного кабинета и сохранение истории прогнозов (АB тестов).

### 1.4. Предпосылки решения
- #### Описание всех общих предпосылок решения, используемых в системе – с обоснованием от запроса бизнеса: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др.

  Машинное обучение стало новой эффективной стратегией, которую можно использовать для торговли акциями. Изменения на рынка акций нелинейные, и часто кажется что цены на акции формируются совершенно случайным образом. Считается что традиционные методы анализа временных рядов, такие модели как ARIMA, эффективны когда ряд является стационарным. Однако проблема возникает в реальной торговой практике где данных стационарность не гарантируется. Решением такой проблемы могут быть нейронные сети, которые не требуют стационарности.

  Команда проекта решила проверить это утверждение на практике и разработать эффективное ml решение модель по прогнозированию цен на акции используя данные Yahoo Finance с ежемесячной динамикой цен и горизонтом прогнозирования в 30 дней и гранулярностью прогноза 1 день.

  В ввиду того что конечный продукт представляет собой информационный сервис в области финансового консалтинга необходимо учитывать законодательные ограничения в этой области. В частности то что инвестиционным советником может быть лицо, квалификацию которого проверил Центробанк и выдал аккредитацию.

## 2. Методология  

### 2.1. Постановка задачи
- #### Что делаем с технической точки зрения: рекомендательная система, поиск аномалий, прогноз, оптимизация, и др.

  Наше ML решение состоит из разработки и реализации модели достаточно точно описывающей динамику цен на акции и поиска подходящих параметров для улучшения модели с помощью оптимизации.

  Решаемые в рамках итерации задачи:

  - Сбор данных о динамике стоимости акций - разработать механизм сбора данных о биржевой торговле акциями .
  - Предобработка данных - провести предобработку собранных данных, включая очистку, масштабирование, генерацию признаков, нормализацию и преобразование данных для последующего обучения модели.
  - Обучение baseline - разработать и обучить базовую модель, способную описать изменение стоимости акции на основе собранных данных.
  - Тестирование других моделей - провести тестирование модели на исторических данных (бэктестинг) и оценить ее точность и эффективность.
  - Документация и планирование будущих итераций - подготовить документацию по проекту, включая инструкции по использованию системы и план развития проекта для будущих итераций.

### 2.2. Блок-схема решения
Блок-схема для бейзлайна и основного MVP с ключевыми этапами решения задачи: подготовка данных, построение прогнозных моделей, оптимизация, тестирование, закрытие технического долга, подготовка пилота, другое.

Изначально планировалась ориентировочно следующая схема реализации решения:

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/1a02207b-fb22-4a69-a92a-85bf0546eae8)

Однако, ввиду того что команда находилась на стадии обучения реализация каждого отдельного этапа приводила к пересмотру требований и возможностей к внедряемому ML-решению, а блок-схему можно представить в следующем ввиде: 

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/ef481952-ff2a-4d8f-ab2b-2ca792da5b85)

### 2.3. Этапы решения задачи
По результатам EDA выделяем следующие этапы решения по разработке информационного сервиса по прогнозированию стоимости акций:

#### Этап 1 – Сбор данных, отбор признаков, анализ
#### Этап 2 - Обработка данных, подготовка к обучению
#### Этап 3 – Поиск и обучение модели с необходимым для бейзлайна уровнем метрик 
#### Этап 4 – Анализ результатов и оптимизация
#### Этап 5 – Развертывание модели в тестовой среде
#### Этап 6 – Формируем требования к ML модели и продукту в целом
#### Этап 7 – Создание пилота и согласование метрик пилота
#### Этап 8 - Подготовка модели деплою
#### Этап 9 - Деплой

#### Этап 1. Сбор данных, отбор признаков, анализ  
Скачиваем архивные данные о стоимости. Загружаем их в среду разработки. При отборе проверяем заполненность данных. Убираем крайне малозаполненные данные или малодостоверные. По итогу количественные признаки должны быть количественными, качественные качественными. 

Целевая переменная представляет среднюю цену между дневной ценой открытия и закрытия:

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/48d290a1-cfd3-4b66-9b65-c7ee85438f22)

Признаки:

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/480aca9a-af8d-4574-abc3-d27cfe570434)

#### Этап 2. Обработка данных, подготовка к обучению  
Преобразование данных в необходимый формат. Формирование тестового и обучающего набора данных

#### Этап 3. Поиск и обучение модели с необходимым для бейзлайна уровнем метрик  
Определяем метрики качества модели: Mean Absolute Error (MAE), Root Mean Squared Error (RMSE) и R-squared (R2). В качестве бейзлайна используем линейную регрессию. Подбираем и проверяем несколько моделей для поиска наилучшего решения. В случае, если в результате обучения качество модели не удаётся поднять до уровня бейзлайна, проводим дополнительное изучение данных

#### Этап 4. Анализ результатов
Проверка значимости признаков и представленности различных групп факторов. Интерпретации результата. Регуляризация в случае переобучения модели.

#### Этап 5. Развертывание модели в тестовой среде
Дополнительная бизнес-проверка и в случае подтверждения результата и соответствия модели бизнес-требованиям запуск пилота согласно 3 разделу дизайн-дока. Готовим пилот согласно требованиям заказчика, переносим туда нашу модель и добиваемся того, чтобы модель исполнялась согласно заявленной логике. Настраиваем интеграцию с базой данных, разворачиваем интерфейс и настраиваем пайплайны.

#### Этап 6. Формируем требования к ML модели и продукту в целом. 
Проводим расчёт вычислительной мощности необходимой для работы системы. Заполняем 4-й раздел дизайн-дока. MVP: составлены системные требования для модели

#### Этап 7. Создание пилота и согласование метрик пилота
Определяем финальные метрики, прокси-метрики и технические метрики, при достижении которых модель будет запущена в деплой. Цели подтверждает заказчик, дата-саентист и дата-инженер.
MVP: определены целевые метрики на основании имеющихся данных и согласованные с бизнесом

#### Этап 8. Подготовка модели к деплою 
Проводим обогощение модели данными, улучшаем предобработку и подбор параметров модели до тех пор, пока не удастся достичь заявленные цели.
MVP: модель, удовлетворяющая заявленным метрикам

#### Этап 9. Деплой
Выкатываем модель в рабочую среду и проводим тестирование на достижение метрик и отказоустойчивости согласно требованиям.

## 3. Подготовка пилота

### 3.1. Способ оценки пилота

Данная итерация продукта не предполагает его коммерческое использование. В рамках проекта предлагается разработать ML-модель и сделать ее частью информационного сервиса. Поэтому главными критерии это законченность, жизнеспособность, стабильность работы сервиса и формирования у команды разработки видения большой картины продукта. Также важным является проверка гипотезе о возможности прогнозирования цен на акции и последующая проверка практической ценности такого прогнозирования для задач долгосрочного инвестирования. 

Наиболее правильным было бы назвать запускаемый пилот «внутренним» Proof of Concept необходимым для запуска в рамках следующей итерации пилота направленного уже на конкретный клиентский «внешний» сегмент. 

### 3.2. Что считаем успешным пилотом

Внутренними метриками оценки качества модели прогнозирования является MAE, RMSE и R2.

Параметры по бейзлайн:  
Mean Absolute Error (MAE): 3.5881780367016165  
Root Mean Squared Error (RMSE): 4.071179010949673   
R-squared (R2): 0.921578320266733  

Лучшие параметры по модели:  
Mean Absolute Error (MAE): 3.698007966482993  
Root Mean Squared Error (RMSE): 4.396554656734088  
R-squared (R2): 0.9085422114935904  

Успешным считается сохранение полученных параметров MAE, RMSE и R2 в течении следующих 6 месяцев прогнозирования стоимости акций компании после окончания 1 итерации.

При реализации 2 итерации следующие метрики должны быть направленны на конкретный коммерческий сегмент и более понятны инвесторам (доходность, ROI, упущенная выгода, инвестиционный доход и т.п.).

### 3.3. Подготовка пилота

На 1 итерации ожидаемые затраты на вычисления незначительны.

## 4. Внедрение для production систем, если требуется

### 4.1. Архитектура решения
Блок схема и пояснения: сервисы, назначения, методы API

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/e898c108-cf8b-4a8d-8ab0-6ca7563dfe3b)

### 4.2. Описание инфраструктуры и масштабируемости

![image](https://github.com/Alesandrio/ML-SD2023/assets/147096165/486482f7-8375-4eb9-8961-c9ed41824f37)

### 4.3. Требования к работе системы
SLA, пропускная способность и задержка Data Scientist

### 4.4. Безопасность системы

Предлагаемое решение может стокнуться со следующими угрозамя характерными для интернет-сервисами: 
- нарушение контроля доступа;
- недочёты криптографии;
- инъекции;
- небезопасный дизайн;
- небезопасная конфигурация;
- использование уязвимых или устаревших компонентов;
- ошибки идентификации и аутентификации;
- нарушения целостности программного обеспечения и данных;
- ошибки логирования и мониторинга безопасности;
- подделка запросов на стороне сервера.

### 4.5. Безопасность данных

Нарушения GDPR или других законов не допускаются. 

### 4.6. Издержки

Расчетные издержки на работу системы связаны только с покупкой хостинга для размещения базы данных. 

### 4.5. Integration points

Описание взаимодействия между сервисами (методы API и др.) Data Scientist

### 4.6. Риски
Описание рисков и неопределенностей, которые стоит предусмотреть Data Scientist

















